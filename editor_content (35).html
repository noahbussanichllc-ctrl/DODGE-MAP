<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dodge Report Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body class="h-screen flex flex-col" x-data="app">
  <!-- Top Bar -->
  <div class="bg-gray-100 p-4 flex flex-wrap items-center gap-4">
    <button class="py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-700" @click="reloadData">Reload Data</button>
    <button class="py-2 px-4 bg-green-600 text-white rounded hover:bg-green-700" @click="saveCsv">Save CSV</button>
    <button class="py-2 px-4 bg-purple-600 text-white rounded hover:bg-purple-700" @click="addNewProject">Add Project</button>
    <button class="py-2 px-4 bg-red-600 text-white rounded hover:bg-red-700" @click="clearChanges">Clear Changes</button>
    <input type="text" placeholder="Search..." class="p-2 border rounded" x-model.debounce.500ms="searchQuery">
  </div>

  <!-- Layout -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Left: Table -->
    <div class="w-1/4 overflow-y-auto border-r p-4">
      <template x-if="data.length === 0">
        <div class="text-center text-gray-500">Loading data...</div>
      </template>
      <template x-if="errorMessage">
        <div class="bg-red-100 p-4 rounded mb-4" x-text="errorMessage"></div>
      </template>
      <table class="w-full table-auto" x-show="filteredData.length > 0">
        <thead class="sticky top-0 bg-white">
          <tr>
            <th class="px-4 py-2">Project Title</th>
            <th class="px-4 py-2">City</th>
            <th class="px-4 py-2">Sub-Type</th>
            <th class="px-4 py-2">Start</th>
            <th class="px-4 py-2">Completion</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(item, index) in paginatedData" :key="index">
            <tr class="cursor-pointer hover:bg-gray-100"
              :class="{ 'bg-blue-50': selectedIndex === filteredData.indexOf(item) }"
              @click="selectItem(item)">
              <td class="px-4 py-2" x-text="item['Project Title']"></td>
              <td class="px-4 py-2" x-text="item['City']"></td>
              <td class="px-4 py-2" x-text="item['Property Type - Sub-type']"></td>
              <td class="px-4 py-2" x-text="item['Target Dates - Start']"></td>
              <td class="px-4 py-2" x-text="item['Target Dates - Completion']"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- Center: Map -->
    <div class="flex-1" id="map"></div>

    <!-- Right: Details -->
    <div class="w-1/4 overflow-y-auto border-l p-4" x-show="selectedItem">
      <div class="mb-4">
        <label class="block font-bold">Project Title</label>
        <input type="text" class="w-full p-2 border rounded" x-model="selectedItem['Project Title']">
      </div>
      <div class="mb-4">
        <label class="block font-bold">City</label>
        <input type="text" class="w-full p-2 border rounded" x-model="selectedItem['City']">
      </div>
      <div class="mb-4">
        <label class="block font-bold">Construction Details</label>
        <textarea class="w-full p-2 border rounded" rows="4" x-model="selectedItem['Construction Details']"></textarea>
      </div>
      <div class="mb-4">
        <label class="block font-bold">NOTES - NOAH</label>
        <textarea class="w-full p-2 border rounded" rows="4" x-model="selectedItem['NOTES - NOAH']"></textarea>
      </div>
      <button class="py-2 px-4 bg-blue-600 text-white rounded" @click="saveItem(selectedItem)">Save Changes</button>
    </div>
  </div>

  <!-- Legend -->
  <div class="absolute bottom-4 left-1/4 bg-white p-4 rounded shadow z-[1000] flex gap-4">
    <div class="flex items-center"><span class="w-4 h-4 bg-[#16a34a] mr-2"></span>Completed</div>
    <div class="flex items-center"><span class="w-4 h-4 bg-[#f97316] mr-2"></span>Under Construction</div>
    <div class="flex items-center"><span class="w-4 h-4 bg-[#2563eb] mr-2"></span>Pre-Planning</div>
    <div class="flex items-center"><span class="w-4 h-4 bg-[#ec4899] mr-2"></span>Subsidized / Mixed Income</div>
    <div class="flex items-center"><span class="w-4 h-4 bg-[#6b7280] mr-2"></span>Unknown</div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        data: [],
        filteredData: [],
        paginatedData: [],
        selectedItem: null,
        selectedIndex: -1,
        searchQuery: '',
        currentPage: 1,
        pageSize: 50,
        map: null,
        markers: [],
        supabase: null,
        errorMessage: '',

        async init() {
          // 🧭 Supabase setup
          const supabaseUrl = 'https://thikqpiwswcyfdpvbpai.supabase.co'; // 🔹 Replace with your project URL
          const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoaWtxcGl3c3djeWZkcHZicGFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NjQ5OTEsImV4cCI6MjA3NjU0MDk5MX0.QMtrdl3DOJ6yUEXfZmhjKK12cCXXc6EJ35XldCTqyiw'; // 🔹 Replace with your anon key
          this.supabase = supabase.createClient(supabaseUrl, supabaseKey);

          // 🌎 Map setup
          this.map = L.map('map').setView([39.5, -98.35], 4);
          L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: 'Map data © Google' }).addTo(this.map);
          this.markerLayer = L.layerGroup().addTo(this.map);

          await this.fetchFromSupabase();
        },

        async fetchFromSupabase() {
          try {
            const { data, error } = await this.supabase.from('dodge').select('*').order('id', { ascending: true });
            if (error) throw error;
            this.processData(data);
          } catch (err) {
            this.errorMessage = 'Error loading from Supabase: ' + err.message;
          }
        },

        processData(raw) {
          this.data = raw.filter(r => r['Geocodes - Latitude'] && r['Geocodes - Longitude']);
          this.filteredData = this.data;
          this.updateMarkers();
        },

        updateMarkers() {
          this.markerLayer.clearLayers();
          this.filteredData.forEach(item => {
            const lat = parseFloat(item['Geocodes - Latitude']);
            const lon = parseFloat(item['Geocodes - Longitude']);
            if (isNaN(lat) || isNaN(lon)) return;
            const marker = L.marker([lat, lon]).bindTooltip(item['Project Title'] || '');
            marker.on('click', () => this.selectItem(item));
            this.markerLayer.addLayer(marker);
          });
        },

        selectItem(item) {
          this.selectedItem = item;
        },

        async saveItem(item) {
          try {
            const updates = { ...item };
            delete updates.lat; delete updates.lon;
            const { error } = await this.supabase.from('dodge').update(updates).eq('id', item.id);
            if (error) throw error;
            alert('✅ Saved successfully');
          } catch (err) {
            alert('❌ Error saving: ' + err.message);
          }
        },

        async reloadData() {
          await this.fetchFromSupabase();
        },

        saveCsv() {
          const headers = Object.keys(this.data[0] || {});
          let csv = headers.join(',') + '\n';
          this.data.forEach(row => {
            csv += headers.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(',') + '\n';
          });
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          saveAs(blob, 'DODGE REPORT.csv');
        },

        async addNewProject() {
          const newRow = { 'Project Title': 'New Project', 'City': '', 'Geocodes - Latitude': '39.5', 'Geocodes - Longitude': '-98.35' };
          const { data, error } = await this.supabase.from('dodge').insert([newRow]).select();
          if (error) return alert('Error adding: ' + error.message);
          this.data.push(data[0]);
          this.updateMarkers();
        },

        clearChanges() {
          localStorage.clear();
          this.fetchFromSupabase();
        }
      }));
    });
  </script>
</body>
</html>
